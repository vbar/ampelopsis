{% extends "base.html" %}

{% block declarations %}
<style>

#search-row {
    margin-top: 4px;
}

.axis text {
    font-family: sans-serif;
    font-size: 12pt;
    cursor: default;
}

.axis .label {
    font-size: 12pt;
}

.axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

</style>
{% endblock %}


{% block content %}
<div class="container-fluid">
  <div id="search-row" class="row g-4">
    <div class="col-1">
      <div class="top-link">
        <a href="{{ url_for('overview.frame') }}">index</a>
      </div>
    </div>
    <div class="col-8">
    </div>
    <div class="col-2">
      <input class="form-control form-control-sm" type="text" id="search-text">
    </div>
    <div class="col-1">
      <button id="search-button" class="btn btn-primary mb-3">Hledat</button>
    </div>
  </div>
</div>
<div class="container-fluid" id="the_graph"></div>
{% endblock %}


{% block scripts %}
<script>
$("body").css("cursor", "progress");

const margin = {top: 10, right: 30, bottom: 60, left: 10},
      contentMargin = 40,
      height = 500 - margin.top - margin.bottom,
      dateParse = d3.timeParse("%Y-%m-%d");

$('#the_graph').on('click', '.axis text', function () {
    var year = $(this).text(),
        textArray = [ year + "-01-01", year + "-12-31" ],
        secondArray = textArray.map(t => dateParse(t).getTime() / 1000),
        fragment = '#' + secondArray[0] + '/' + secondArray[1],
        searchFilter = $("#search-text").val();

    if (searchFilter.length > 1) {
        fragment += "/";
        fragment += encodeURIComponent(searchFilter);
    }

    window.open("{{ url_for('overview.frame') }}" + fragment, "_self");
});

d3.json(getDataUrl("")).then(update, showError);

$('#search-text').keyup(function (e) {
    if (e.keyCode == 13) {
        e.stopPropagation();
        updateFilter();
    }
});

$("#search-button").on("click", function (e) {
    e.stopPropagation();
    updateFilter();
});

resizeTimer = null;
lastWidth = null;

window.onresize = function (event) {
    if (window.innerWidth == lastWidth) {
        return;
    }

    lastWidth = window.innerWidth;

    if (resizeTimer) {
        clearTimeout(resizeTimer);
    }

    if (metadata) {
        resizeTimer = setTimeout(function () {
            d3.select("svg").remove();
            draw();
        }, 100);
    }
};

function updateFilter() {
    var v = $("#search-text").val();
    if (v.length == 1) {
        showError("Jednopísmenná slova nejsou indexována.");
        $("#search-text").val("");
        return;
    }

    $("body").css("cursor", "progress");

    d3.select("svg").remove();
    d3.json(getDataUrl(v)).then(update, showError);
}

function getDataUrl(searchFilter) {
    var url = "{{ url_for('.data') }}";

    if (searchFilter) {
        url += "?s=" + encodeURIComponent(searchFilter);
    }

    return url;
}

function update(mt) {
    metadata = mt;
    draw();
    $("body").css("cursor", "default");
}

function draw() {
    var width = window.innerWidth - contentMargin - margin.left - margin.right;

    var svg = d3.select("#the_graph").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
              `translate(${margin.left}, ${margin.top})`);

    var xLabels = [],
        yValues = [],
        zValues = [],
        stackInput = new d3.InternMap();

    metadata.summary.forEach(function (compo) {
        var year = compo.year,
            inner = new d3.InternMap();

        xLabels.push(year);
        for (var key in compo) {
            if (!isNaN(parseInt(key, 10))) {
                inner.set(key, yValues.length);
                yValues.push(compo[key]);
                zValues.push(key);
            }
        }

        stackInput.set(year, inner);
    });

    var stackGen = d3.stack()
        .keys(metadata.order)
        .value(function (d, key) {
            var z2idx = d[1], // x is in d[0]
                i = z2idx.get(key);

            return (i == undefined) ? 0 : yValues[i];
        }),
        stackOutput = stackGen(stackInput),
        series = stackOutput.map(s => s.map(function (d) {
            d.party = s.key;
            return d;
        }));

    var yDomain = d3.extent(series.flat(2)),
        xScale = d3.scaleBand(xLabels, [margin.left, margin.left + width]).paddingInner(0.1),
        yScale = d3.scaleLinear(yDomain, [margin.top + height, margin.top]),
        xAxis = d3.axisBottom(xScale).tickSizeOuter(0);

  svg.append("g")
      .attr("transform", `translate(${margin.left},0)`)
      .call(g => g.select(".domain").remove())
      .call(g => g.selectAll(".tick line").clone()
          .attr("x2", width)
          .attr("stroke-opacity", 0.1));

  var bar = svg.append("g")
      .selectAll("g")
      .data(series)
      .join("g")
      .attr("fill", ([{party}]) => metadata.legend[party][1])
      .selectAll("rect")
      .data(d => d)
      .join("rect")
      .attr("x", function (d) {
          return xScale(d.data[0]);
      })
      .attr("y", ([y1, y2]) => Math.min(yScale(y1), yScale(y2)))
      .attr("height", ([y1, y2]) => Math.abs(yScale(y1) - yScale(y2)))
      .attr("width", xScale.bandwidth());

    bar.append("title")
        .text(({party}) => metadata.legend[party][0]);

    svg.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${yScale(0)})`)
      .call(xAxis);
}

</script>
{% endblock %}
