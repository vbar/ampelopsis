<!-- based on https://observablehq.com/@d3/stacked-bar-chart -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Shrnut√≠</title>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <style>

      .axis text {
        font-family: sans-serif;
        font-size: 12pt;
      }
      .axis .label {
        font-size: 12pt;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

    </style>
  </head>
  <body>
    <div id="the_graph"></div>

    <script>

const margin = {top: 10, right: 30, bottom: 60, left: 10},
      width = 1100 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

var svg = d3.select("#the_graph").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

d3.json("volume.json").then(function (metadata) {
    var xLabels = [],
        yValues = [],
        zValues = [],
        stackInput = new d3.InternMap();

    metadata.summary.forEach(function (compo) {
        var year = compo.year,
            inner = new d3.InternMap();

        xLabels.push(year);
        for (var key in compo) {
            if (!isNaN(parseInt(key, 10))) {
                inner.set(key, yValues.length);
                yValues.push(compo[key]);
                zValues.push(key);
            }
        }

        stackInput.set(year, inner);
    });

    var stackGen = d3.stack()
        .keys(metadata.order)
        .value(function (d, key) {
            var z2idx = d[1], // x is in d[0]
                i = z2idx.get(key);

            return (i == undefined) ? 0 : yValues[i];
        }),
        stackOutput = stackGen(stackInput),
        series = stackOutput.map(s => s.map(function (d) {
            d.party = s.key;
            return d;
        }));

    var yDomain = d3.extent(series.flat(2)),
        xScale = d3.scaleBand(xLabels, [margin.left, margin.left + width]).paddingInner(0.1),
        yScale = d3.scaleLinear(yDomain, [margin.top + height, margin.top]),
        xAxis = d3.axisBottom(xScale).tickSizeOuter(0);

  svg.append("g")
      .attr("transform", `translate(${margin.left},0)`)
      .call(g => g.select(".domain").remove())
      .call(g => g.selectAll(".tick line").clone()
          .attr("x2", width)
          .attr("stroke-opacity", 0.1));

  var bar = svg.append("g")
    .selectAll("g")
    .data(series)
    .join("g")
        .attr("fill", ([{party}]) => metadata.legend[party][1])
    .selectAll("rect")
    .data(d => d)
    .join("rect")
      .attr("x", function (d) {
          return xScale(d.data[0]);
      })
      .attr("y", ([y1, y2]) => Math.min(yScale(y1), yScale(y2)))
      .attr("height", ([y1, y2]) => Math.abs(yScale(y1) - yScale(y2)))
      .attr("width", xScale.bandwidth());

    bar.append("title")
        .text(({party}) => metadata.legend[party][0]);

    svg.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${yScale(0)})`)
      .call(xAxis);
});

    </script>
  </body>
</html>
