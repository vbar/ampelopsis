<!-- based on https://www.d3-graph-gallery.com/graph/lollipop_horizontal.html -->
<!DOCTYPE html>
<meta charset="utf-8">
<title>Nejčastější slova</title>

<script src="https://d3js.org/d3.v4.js"></script>
<style>
text.legend {
    font-family: sans-serif;
    font-size: 10pt;
    dominant-baseline: middle;
}
</style>

<span id="the_graph"></span>
<span id="the_legend"></span>
<div id="footer"></div>

<script>

var margin = {top: 10, right: 30, bottom: 40 },
    legendMargin = {top: 12, right: 12, bottom: 12, left: 12},
    totalWidth = 510,
    totalHeight = 800,
    maxRadius = 20;

var svg = d3.select("#the_graph")
    .append("svg")
    .attr("width", totalWidth)
    .attr("height", totalHeight)
    .append("g");

d3.json("vocab.json", function (metadata) {
    var dateParse = d3.timeParse("%Y-%m-%dT%H:%M:%S%Z"),
	dateFormat = d3.timeFormat('%-d.%-m.%Y'),
	height = 800 - margin.top - margin.bottom,
	parties = metadata.parties,
	data = metadata.data,
	dateExtent = [ dateParse(metadata.dateExtent[0]), dateParse(metadata.dateExtent[1]) ],
	maxWordLen = d3.max(data, function (d) { return d[0].length; }),
	marginLeft = 10 + 7 * maxWordLen,
	footer = document.getElementById('footer'),
	keys = Object.keys(parties)
	.sort(function (k1, k2) {
	    return parties[k2].total - parties[k1].total;
	}),
	last = null,
	stack = [];

    footer.innerHTML = dateFormat(dateExtent[0]) + " - " + dateFormat(dateExtent[1]);

    var x = d3.scaleLinear()
	.domain([0, d3.max(data, function (d) { return d[2]; })])
	.range([0, totalWidth - marginLeft - margin.right]);
    svg.attr("transform",
	     "translate(" + marginLeft + "," + margin.top + ")")
	.append("g")
	.attr("transform", "translate(0," + height + ")")
	.call(d3.axisBottom(x))
	.selectAll("text")
	.attr("transform", "translate(-10,0) rotate(-45)")
	.style("text-anchor", "end");

    var y = d3.scaleBand()
	.range([0, height])
	.domain(data.map(function (d) { return d[0]; }))
	.padding(1);
    svg.append("g")
	.call(d3.axisLeft(y))

    svg.selectAll("stem")
	.data(data)
	.enter()
	.append("line")
	.attr("x1", function (d) { return x(d[2]); })
	.attr("x2", x(0))
	.attr("y1", function (d) { return y(d[0]); })
	.attr("y2", function (d) { return y(d[0]); })
	.attr("stroke", "grey");

    svg.selectAll("marker")
	.data(data)
	.enter()
	.append("circle")
	.attr("cx", function (d) { return x(d[2]); })
	.attr("cy", function (d) { return y(d[0]); })
	.attr("r", "4")
	.style("fill", function (d) { return parties[d[1]].color; })
	.append("title").text(function (d) { return d[1]; });

    // legend is in separate span
    svg = d3.select("#the_legend")
	.append("svg")
	.attr("width", totalWidth)
	.attr("height", totalHeight)
	.append("g")
	.attr("transform",
	      "translate(" + legendMargin.left + "," + legendMargin.top + ")");

    var sqrtScale = d3.scaleSqrt()
	.domain([0, parties[keys[0]].total])
	.range([0, maxRadius]);

    keys.forEach(function (nm) {
	var prev = 0;
	if (stack.length) {
	    prev = stack[stack.length - 1] + last;
	}

	last = 0.8 * sqrtScale(parties[nm].total);
	if (last < 10) {
	    last = 10;
	}

	stack.push(prev + last);
    });

    svg.selectAll("graphic")
	.data(keys)
	.enter()
	.append("circle")
	.attr("cx", function (d) { return 2 * maxRadius - sqrtScale(parties[d].total); })
	.attr("cy", function (d, i) { return stack[i]; })
	.attr("r", function (d) { return sqrtScale(parties[d].total); })
	.style("fill", function (d) { return parties[d].color; })
	.on("click", function (d) {
	    if (d3.event.defaultPrevented) return;

	    if ('ext_url' in parties[d]) {
		window.open(parties[d].ext_url);
	    }
	})
	.append("title").text(function (d) { return parties[d].total + " slov"; });

    svg.selectAll("name")
	.data(keys)
	.enter()
	.append("text")
	.attr("class", "legend")
	.attr("x", 2 * maxRadius + 8)
	.attr("y", function (d, i) { return stack[i]; })
	.text(function(d) { return d; });
});

</script>
