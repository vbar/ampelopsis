<!-- based on code from d3-graph-gallery.com and http://bl.ocks.org/AndrewRP/7468330 -->
<!DOCTYPE html>
<meta charset="utf-8">
<title>Stranická komunikace</title>

<script src="https://d3js.org/d3.v5.min.js"></script>

<div id="the_graph"></div>
<div id="footer"></div>

<script>
function get_samples(metadata, matrix, i, j) {
    var row = matrix[metadata[i].name],
	cell = row ? row[metadata[j].name] : [];

    return cell;
}

var diameter = 880,
    radius = diameter / 2,
    innerRadius = radius - 30;

// create the svg area
var svg = d3.select("#the_graph")
    .append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .append("g")
    .attr("transform", "translate(" + radius + ", " + radius + ")")

d3.json("chord.json").then(function(graphData) {
    if ('dateExtent' in graphData) {
	var dateParse = d3.timeParse("%Y-%m-%dT%H:%M:%S%Z"),
	    dateFormat = d3.timeFormat('%-d.%-m.%Y'),
	    dateExtent = [ dateParse(graphData.dateExtent[0]), dateParse(graphData.dateExtent[1]) ],
	    footer = document.getElementById('footer');
	footer.innerHTML = dateFormat(dateExtent[0]) + " - " + dateFormat(dateExtent[1]);
    }

    var metadata = graphData.desc,
	tooltips = graphData.matrixDesc,
	sampleMatrix = graphData.samples,
	ribbon2index = {},
	res = d3.chord()
	    .padAngle(0.02)     // padding between entities (black arc)
	    .sortSubgroups(d3.descending)
	    (graphData.matrix)

    // add the groups on the inner part of the circle
    var group = svg.datum(res)
	.append("g")
	.selectAll("g")
	.data(function(d) { return d.groups; })
	.enter()
	.append("g");

    var groupPath = group.append("path")
	.style("fill", function (d, i) { return metadata[i].color; })
	.style("stroke", "black")
	.attr("id", function (d, i) { return "group" + i; })
	.attr("d", d3.arc()
	      .innerRadius(innerRadius)
	      .outerRadius(innerRadius + 20)
	     )

    var lengths = groupPath._groups[0].map(function (it) { return it.getTotalLength(); });

    group.append("text")
	.attr("x", 6)
	.attr("dy", 15)
	.attr("fill", "white")
	.append("textPath")
	.attr("xlink:href", function (d, i) { return "#group" + i; })
	.text(function (d, i) {
	    var l = Math.floor(lengths[i] / 35);
	    if (l < 2) {
		return "";
	    } else {
		if (l < 4) {
		    --l;
		}

		var name = metadata[i].name;
		return l >= name.length ? name : name.substr(0, l) + "\u2026";
	    }
	});

    group.append("title").text(function(d, i) {
	return metadata[i].name;
    });

    // Add the links between groups
    svg.datum(res)
	.append("g")
	.selectAll("path")
	.data(function(d) { return d; })
	.enter()
	.append("path")
	.attr("d", d3.ribbon()
	      .radius(innerRadius)
	     )
	.style("fill", function (d) { return metadata[d.source.index].color; })
	.style("stroke", "black")
	.on("click", function (d) {
	    if (d3.event.defaultPrevented) return;

	    var samples = get_samples(metadata, sampleMatrix, d.source.index, d.target.index);
	    if (samples.length) {
		var key = d.source.index.toString() + '-' + d.target.index.toString(),
		    idx = (key in ribbon2index) ? (ribbon2index[key] + 1) : 0;
		if (idx >= samples.length) {
		    idx = 0;
		}

		window.open(samples[idx]);
		ribbon2index[key] = idx;
	    }
	})
	.append("title").text(function (d) {
	    var row = tooltips[metadata[d.source.index].name],
		cell = row ? row[metadata[d.target.index].name] : "";
	    if (cell) {
		return cell;
	    }

	    var samples = get_samples(metadata, sampleMatrix, d.source.index, d.target.index);
	    if (!samples) {
		return "";
	    } else {
		return samples.length == 1 ? "příklad" : "příklady";
	    }
	});
});

</script>
